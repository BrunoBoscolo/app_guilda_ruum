{% extends 'guilda_manager/_base_bestiario.html' %}
{% load static %}

{% block title %}Rememoração - Bestiário{% endblock %}

{% block extra_head %}
<style>
    /* Custom Styles from Screen 1 */
    .torn-edge {
        position: absolute;
        bottom: -20px;
        left: 0;
        width: 100%;
        height: 40px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320' preserveAspectRatio='none'%3E%3Cpath fill='%23FDFBF7' fill-opacity='1' d='M0,160L40,170.7C80,181,160,203,240,192C320,181,400,139,480,122.7C560,107,640,117,720,133.3C800,149,880,171,960,165.3C1040,160,1120,128,1200,112C1280,96,1360,96,1400,96L1440,96L1440,320L1400,320C1360,320,1280,320,1200,320C1120,320,1040,320,960,320C880,320,800,320,720,320C640,320,560,320,480,320C400,320,320,320,240,320C160,320,80,320,40,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-size: cover;
        z-index: 20;
        filter: drop-shadow(0px -4px 6px rgba(0,0,0,0.3));
    }

    /* D6 Dice CSS */
    .d6-flat {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        display: grid;
        padding: 4px;
        position: relative;
        box-shadow: inset 0 0 4px rgba(0,0,0,0.2);
        transition: transform 0.2s;
    }
    .d6-flat:hover { transform: scale(1.1); }
    .dot {
        border-radius: 50%;
        background-color: currentColor;
        display: block;
        width: 7px;
        height: 7px;
        align-self: center;
        justify-self: center;
    }
    .face-1 { display: flex; align-items: center; justify-content: center; }
    .face-2 { display: flex; justify-content: space-between; }
    .face-2 .dot:nth-child(1) { align-self: flex-start; }
    .face-2 .dot:nth-child(2) { align-self: flex-end; }
    .face-3 { display: flex; justify-content: space-between; }
    .face-3 .dot:nth-child(1) { align-self: flex-start; }
    .face-3 .dot:nth-child(2) { align-self: center; }
    .face-3 .dot:nth-child(3) { align-self: flex-end; }
    .face-4 { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
    .face-5 { display: grid; grid-template-areas: "a . c" ". e ." "g . i"; grid-template-rows: 1fr 1fr 1fr; grid-template-columns: 1fr 1fr 1fr;}
    .face-5 .dot:nth-child(1) { grid-area: a; }
    .face-5 .dot:nth-child(2) { grid-area: c; }
    .face-5 .dot:nth-child(3) { grid-area: e; }
    .face-5 .dot:nth-child(4) { grid-area: g; }
    .face-5 .dot:nth-child(5) { grid-area: i; }
    .face-6 { display: grid; grid-template-rows: 1fr 1fr 1fr; grid-template-columns: 1fr 1fr; gap: 2px; }

    .theme-gold {
        background: linear-gradient(135deg, #F9E79F, #D4AC0D);
        border: 1px solid #B7950B;
        color: #3e3312;
        box-shadow: 0 0 12px rgba(212, 172, 13, 0.6);
    }
    .theme-red {
        background: linear-gradient(135deg, #C0392B, #922B21);
        border: 1px solid #7B241C;
        color: #F9EBEA;
        box-shadow: 0 0 12px rgba(169, 50, 38, 0.6);
    }
    .theme-ivory {
        background: linear-gradient(135deg, #F2F3F4, #D7DBDD);
        border: 1px solid #99A3A4;
        color: #2C3E50;
        box-shadow: 0 0 10px rgba(200, 200, 200, 0.5);
    }

    /* Locked overlay */
    .locked-overlay {
        pointer-events: none;
        opacity: 0.6;
        filter: grayscale(1);
    }
</style>
{% endblock %}

{% block content %}
<section class="bg-background-dark text-gray-200 relative pb-16">
    <div class="h-1 w-full bg-gradient-to-r from-primary via-gold to-primary sticky top-0 z-50 shadow-[0_0_15px_rgba(212,172,13,0.5)]"></div>
    <div class="max-w-md mx-auto px-4 pt-8 pb-12">
        <header class="mb-8 flex flex-col items-center text-center">
            <div class="w-16 h-16 rounded-full border-2 border-gold/50 bg-card-dark flex items-center justify-center mb-3 shadow-gold-glow">
                <span class="material-symbols-outlined text-3xl text-gold">psychology</span>
            </div>
            <h1 class="font-display text-2xl font-bold text-gold tracking-widest uppercase mb-1 drop-shadow-md">Ferramenta de Rememoração</h1>
            <p class="text-xs text-gray-500 italic font-serif">Rito de Acesso à Memória Ancestral</p>
        </header>

        {% if error_message %}
            <div class="bg-primary/20 border border-primary text-red-200 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Erro!</strong>
                <span class="block sm:inline">{{ error_message }}</span>
            </div>
        {% endif %}

        <form method="POST" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="action" value="roll">

            <div class="bg-card-dark border border-gray-800 rounded-lg p-4 shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-40 transition-opacity">
                    <span class="material-symbols-outlined text-4xl text-primary">fingerprint</span>
                </div>
                <label class="block text-xs font-bold text-primary uppercase tracking-wider mb-2">Alvo do Ritual</label>
                <div class="flex items-center space-x-3 border-b border-gray-700 pb-2">
                    <div class="bg-gray-800 rounded p-2">
                        <span class="material-symbols-outlined text-gray-400">person_search</span>
                    </div>
                    <select name="monster_id" class="bg-transparent border-none text-white font-display text-lg focus:ring-0 p-0 w-full placeholder-gray-600 appearance-none">
                        <option value="" class="bg-background-dark">Selecione uma criatura...</option>
                        {% for m in monsters %}
                            <option value="{{ m.id }}" class="bg-background-dark" {% if selected_monster and selected_monster.id == m.id %}selected{% endif %}>{{ m.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Settings -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-card-dark border border-gray-800 rounded-lg p-3">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dificuldade (CD)</label>
                     <select name="dc" class="w-full bg-transparent border-none text-white font-display text-sm focus:ring-0 p-0">
                        <option value="15" class="bg-background-dark" {% if dc == 15 %}selected{% endif %}>CD 15 (Mesmo dia)</option>
                        <option value="20" class="bg-background-dark" {% if dc == 20 %}selected{% endif %}>CD 20 (Dia seguinte)</option>
                        <option value="25" class="bg-background-dark" {% if dc == 25 %}selected{% endif %}>CD 25 (Mais tarde)</option>
                        <option value="30" class="bg-background-dark" {% if dc == 30 %}selected{% endif %}>CD 30 (Muito tempo)</option>
                     </select>
                </div>
                 <div class="bg-card-dark border border-gray-800 rounded-lg p-3">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bônus Total</label>
                     <input type="number" name="bonus" value="{{ bonus|default:0 }}" class="w-full bg-transparent border-none text-white font-display text-sm focus:ring-0 p-0 placeholder-gray-600">
                </div>
            </div>

            <div class="flex items-center space-x-4 px-2">
                 <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="is_immediate" class="form-checkbox text-primary rounded bg-gray-800 border-gray-700 focus:ring-offset-gray-900" {% if is_immediate %}checked{% endif %}>
                    <span class="text-xs text-gray-400 font-bold uppercase">Imediato?</span>
                 </label>
                 <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="use_tonic" class="form-checkbox text-gold rounded bg-gray-800 border-gray-700 focus:ring-offset-gray-900" {% if use_tonic %}checked{% endif %}>
                    <span class="text-xs text-gold font-bold uppercase">Usar Tônico?</span>
                 </label>
            </div>

            <button type="submit" class="w-full relative group overflow-hidden rounded bg-primary/20 hover:bg-primary/30 border border-primary/50 text-red-200 py-3 transition-all duration-300">
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-10">
                    <div class="w-full h-full bg-red-600 blur-xl"></div>
                </div>
                <span class="relative flex items-center justify-center gap-2 font-display uppercase tracking-widest text-sm font-bold">
                    <span class="material-symbols-outlined">casino</span> Realizar Teste
                </span>
            </button>
        </form>

        {% if has_result %}
        <div class="relative mt-8 mx-2">
            <div class="absolute inset-0 bg-gold blur-[40px] opacity-10 rounded-full"></div>
            <div class="relative bg-parchment text-gray-900 p-6 rounded-sm shadow-2xl border-2 border-gold/40 transform rotate-1">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-6 bg-yellow-100/30 backdrop-blur-sm border border-white/20 shadow-sm rotate-2"></div>
                <div class="text-center space-y-4">
                    <div>
                        <h3 class="font-display text-xl font-bold text-primary uppercase">{{ result_type }}</h3>
                        {% if not is_immediate %}
                            <p class="text-sm text-gray-600 font-serif italic mt-1">
                                Check: {{ total_check }} (vs CD {{ dc }})
                            </p>
                        {% endif %}
                    </div>
                    <div class="py-4 flex justify-center items-center gap-4 flex-wrap">
                        {% for die in dice_pool %}
                            <div class="d6-flat face-{{ die }} {% if die >= 5 %}theme-gold{% elif die >= 3 %}theme-red{% else %}theme-ivory{% endif %}" title="Resultado: {{ die }}">
                                {% if die == 1 %}<span class="dot"></span>{% endif %}
                                {% if die == 2 %}<span class="dot"></span><span class="dot"></span>{% endif %}
                                {% if die == 3 %}<span class="dot"></span><span class="dot"></span><span class="dot"></span>{% endif %}
                                {% if die == 4 %}<span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>{% endif %}
                                {% if die == 5 %}<span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>{% endif %}
                                {% if die == 6 %}<span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>{% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="flex justify-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wide border-t border-gray-300 pt-3">
                        <span>Vital: {{ vital_count }}</span>
                        <span class="text-gray-300">|</span>
                        <span>Tático: {{ tactical_count }}</span>
                        <span class="text-gray-300">|</span>
                        <span>Vago: {{ vague_count }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="torn-edge"></div>
</section>

{% if has_result and selected_monster %}
<main class="bg-parchment relative pt-12 px-4 max-w-md mx-auto space-y-6">
    <div class="text-center mb-2">
        <h2 class="font-display text-lg font-bold text-gray-800 uppercase tracking-wider">Editor de Memórias</h2>
        <div class="h-0.5 w-12 bg-primary mx-auto mt-2 opacity-50"></div>
    </div>

    <form method="POST" action="{% url 'bestiario_rememoracao' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">
        <input type="hidden" name="monster_id" value="{{ selected_monster.id }}">
        <input type="hidden" name="dice_pool_str" value="{{ dice_pool_str }}">
        <input type="hidden" name="register_level" value="{{ selected_monster.register_level }}">

        {% with unlocked_1=vague_count|add:tactical_count|add:vital_count %}
        <section class="bg-white p-4 rounded-lg shadow-md border-t-4 border-gray-600 relative overflow-hidden mb-6 {% if unlocked_1 == 0 %}locked-overlay{% endif %}">
            <div class="absolute inset-0 parchment-texture pointer-events-none z-0"></div>
            <div class="relative z-10 space-y-4">
                <div class="flex justify-between items-start mb-2">
                    <label class="block font-display text-sm font-bold text-gray-800 uppercase tracking-wide">
                        Criatura
                    </label>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-pink-100 text-pink-800 border border-pink-200 shadow-sm">
                        <span class="material-symbols-outlined text-sm mr-1">{% if unlocked_1 > 0 %}auto_awesome{% else %}lock{% endif %}</span>
                        {% if unlocked_1 > 0 %}Memória Disponível{% else %}Bloqueado{% endif %}
                    </span>
                </div>
                <div class="space-y-1">
                    <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary font-serif text-lg font-bold shadow-sm text-gray-900" type="text" name="name" value="{{ form.name.value }}" {% if unlocked_1 == 0 %}readonly{% endif %}/>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-gray-600 uppercase">Tipo</label>
                        <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="text" name="monster_type" value="{{ form.monster_type.value }}" {% if unlocked_1 == 0 %}readonly{% endif %}/>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-gray-600 uppercase">Tamanho</label>
                        <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="text" name="size" value="{{ form.size.value }}" {% if unlocked_1 == 0 %}readonly{% endif %}/>
                    </div>
                </div>
                <div class="space-y-1 pt-2">
                    <label class="block text-xs font-bold text-gray-600 uppercase">Descrição</label>
                    <textarea class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900 resize-none" rows="3" name="description" {% if unlocked_1 == 0 %}readonly{% endif %}>{{ form.description.value|default_if_none:'' }}</textarea>
                </div>
                <div class="w-1/3 space-y-1">
                    <label class="block text-xs font-bold text-gray-600 uppercase">ND</label>
                    <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900 font-bold text-center" type="number" step="0.01" name="challenge_level" value="{{ form.challenge_level.value|stringformat:'.2f' }}" {% if unlocked_1 == 0 %}readonly{% endif %}/>
                </div>
            </div>
        </section>
        {% endwith %}

        {% with unlocked_2=tactical_count|add:vital_count %}
        <section class="bg-white p-4 rounded-lg shadow-arcane border-t-4 border-primary relative overflow-hidden ring-2 ring-pink-400/30 mb-6 {% if unlocked_2 == 0 %}locked-overlay{% endif %}">
            <div class="absolute inset-0 parchment-texture pointer-events-none z-0"></div>
            <div class="relative z-10 space-y-4">
                <div class="flex justify-between items-center border-b border-primary/20 pb-2 mb-2">
                    <h2 class="font-display text-lg font-bold text-primary uppercase">Dados Táticos</h2>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-pink-100 text-pink-800 border border-pink-200 shadow-[0_0_8px_rgba(236,72,153,0.3)] animate-pulse">
                        {% if unlocked_2 > 0 %}Memória Disponível ({{ unlocked_2 }}){% else %}Bloqueado{% endif %}
                    </span>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-gray-600 uppercase">Papel de Combate</label>
                        <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="text" name="combat_role" value="{{ form.combat_role.value|default_if_none:'' }}" {% if unlocked_2 == 0 %}readonly{% endif %}/>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-gray-600 uppercase">Defesa</label>
                        <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="number" name="defense" value="{{ form.defense.value|default_if_none:'' }}" {% if unlocked_2 == 0 %}readonly{% endif %}/>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-gray-600 uppercase">Deslocamento</label>
                        <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="text" name="movement" value="{{ form.movement.value|default_if_none:'' }}" {% if unlocked_2 == 0 %}readonly{% endif %}/>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-gray-600 uppercase">Habitat</label>
                        <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="text" name="habitat" value="{{ form.habitat.value|default_if_none:'' }}" {% if unlocked_2 == 0 %}readonly{% endif %}/>
                    </div>
                </div>
            </div>
        </section>
        {% endwith %}

        {% with unlocked_3=vital_count %}
        <section class="bg-white p-4 rounded-lg shadow-md border-t-4 border-gold relative overflow-hidden mb-6 {% if unlocked_3 == 0 %}locked-overlay{% endif %}">
            <div class="absolute inset-0 parchment-texture pointer-events-none z-0"></div>
            <div class="relative z-10 space-y-4">
                <div class="flex justify-between items-center border-b border-gold/30 pb-2 mb-2">
                    <h2 class="font-display text-lg font-bold text-primary uppercase">Dados Vitais</h2>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-800 border border-green-200 opacity-60">
                       {% if unlocked_3 > 0 %}Memória Disponível ({{ unlocked_3 }}){% else %}Bloqueado{% endif %}
                   </span>
                </div>
                <div class="space-y-1">
                    <label class="block text-xs font-bold text-gray-600 uppercase">Pontos de Vida (PV)</label>
                    <input class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900" type="number" name="health_points" value="{{ form.health_points.value|default_if_none:'' }}" {% if unlocked_3 == 0 %}readonly{% endif %}/>
                </div>
                <div class="space-y-1">
                    <label class="block text-xs font-bold text-gray-600 uppercase">Fraquezas</label>
                    <textarea class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900 resize-none" rows="2" name="weaknesses" {% if unlocked_3 == 0 %}readonly{% endif %}>{{ form.weaknesses.value|default_if_none:'' }}</textarea>
                </div>
                <div class="space-y-1">
                    <label class="block text-xs font-bold text-gray-600 uppercase">Imunidades</label>
                    <textarea class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900 resize-none" rows="2" name="immunities" {% if unlocked_3 == 0 %}readonly{% endif %}>{{ form.immunities.value|default_if_none:'' }}</textarea>
                </div>
                <div class="space-y-1">
                    <label class="block text-xs font-bold text-gray-600 uppercase">Poderes Especiais</label>
                    <textarea class="block w-full border-gray-300 rounded bg-parchment/50 focus:ring-primary focus:border-primary text-sm text-gray-900 resize-none" rows="3" name="special_abilities" {% if unlocked_3 == 0 %}readonly{% endif %}>{{ form.special_abilities.value|default_if_none:'' }}</textarea>
                </div>
            </div>
        </section>
        {% endwith %}

        <button class="w-full relative group overflow-hidden rounded shadow-lg transform transition active:scale-95 duration-150 mb-6" type="submit">
            <div class="absolute inset-0 bg-gradient-to-b from-[#F9E79F] to-[#D4AC0D] border-2 border-[#B7950B]"></div>
            <div class="absolute inset-0 opacity-0 group-hover:opacity-20 bg-white transition-opacity duration-300"></div>
            <div class="relative py-4 px-6 flex items-center justify-center space-x-2">
                <span class="material-symbols-outlined text-gray-900">save</span>
                <span class="font-display font-bold text-gray-900 text-lg uppercase tracking-widest drop-shadow-sm">Salvar Memórias</span>
            </div>
        </button>
        <div class="h-10"></div>
    </form>
</main>
{% else %}
<div class="bg-parchment h-full min-h-[50vh] flex items-center justify-center">
    <p class="text-gray-500 font-serif italic p-8 text-center">Selecione uma criatura e realize o rito para editar memórias.</p>
</div>
{% endif %}

{% endblock %}
